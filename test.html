<!DOCTYPE html>

<html>

<head>

    <meta charset="UTF-8">

    <title>ä½¿ç”¨canvasç»˜åˆ¶å›¾åƒ</title>
    <script src="index.js"></script>
    <style>
        @font-face {
            font-family: "PingFang";
            src: url(/font/PingFang.ttf);
        }
    </style>
    <p style="font-family: PingFang">å­—ä½“æµ‹è¯•ABCabc 123</p>
</head>

<body>

    <h2>ä½¿ç”¨canvasç»˜åˆ¶å›¾åƒ</h2>

    <canvas width="750" height="1334" id="sample1" style="background-color: #fff; width: 325px;">

        åªæœ‰æ”¯æŒcanvaså…ƒç´ çš„æµè§ˆå™¨æ‰èƒ½æ­£å¸¸æ˜¾ç¤ºå›¾åƒã€‚

    </canvas>

    <script>
        class FakeIos {
            constructor() {
                this.CoreDraw = new fakeChat(750, 1334, document.getElementById('sample1'))
                // ç»˜åˆ¶æ¨¡æ¿èƒŒæ™¯
                
                this.defaultTop = 180;
            }

            async drawTempBg(){
               await this.CoreDraw.drawImage('/temp.png', 0, 0, 750, 1334);
            }
            // ç»˜åˆ¶æ—¶é—´
            drawTime(time) {
                this.CoreDraw.ctx.font = 'Bold 30px "PingFang"'
                var width = this.CoreDraw.ctx.measureText(time).width
                this.CoreDraw.drawText(time, 'Bold 24px "PingFang"', '#fff', { x: (this.CoreDraw.getWidth() - width) / 2, y: 4 })
                this.CoreDraw.drawText(time, 'Bold 24px "PingFang"', '#fff', { x: (this.CoreDraw.getWidth() - width) / 2 - 0.5, y: 4 - 0.5 })
            }

            // ç»˜åˆ¶wifi & 4G
            drawWifi(type) {
                if (type) {
                    this.CoreDraw.drawImage('/i-top-wifi.png', 161, 0, 30, 40); // wifi
                } else {
                    this.CoreDraw.drawText('4G', 'Medium 24px "PingFang"', '#fff', { x: 161, y: 4 }) // 4G
                }
            }

            // è®¡ç®—å­—ç¬¦é•¿åº¦
            strLengthWithDom(str) {
                this.CoreDraw.ctx.font = '30px "PingFang"'
                return this.CoreDraw.ctx.measureText(str).width
            }

            // è®¡ç®—å­—ç¬¦é«˜åº¦
            strHeightWithDom(str) {
                this.CoreDraw.ctx.font = '30px "PingFang"'
                return this.CoreDraw.ctx.measureText(str).height
            }

            // ç»˜åˆ¶å¤´åƒ 77*77 left 19px
            drawAvatar(top, type) {
                if (type) {
                    this.CoreDraw.drawImage('/avatar.png', 19, top, 77, 77);
                } else {
                    this.CoreDraw.drawImage('/avatar.png', 654, top, 77, 77);
                }
            }

            async chatBox_other_1(avatar, text) {
                var left = 106
                var top = this.defaultTop
                this.drawAvatar(top, true)
                var chatWidth = this.strLengthWithDom(text)
                var width = 0;
                var line = 0;
                var lastIdx = 0;
                var strs = []
                for (var i = 0; i < text.length; i++) {
                    width += this.strLengthWithDom(text[i])
                    if (width > 420) {
                        var _text = text.substring(lastIdx, (i + (line === 0 ? 1 : 0)))
                        strs.push(_text)
                        lastIdx = i;
                        width = 0;
                        line++;
                    }

                    if (i === text.length - 1) {
                        strs.push(text.substring(lastIdx + 1))
                        line++;
                    }
                }

                if (chatWidth > 420) {
                    // æ¢è¡Œ
                    chatWidth = 440;
                }

                var left = 115;
                var top = top;
                var height = (line === 0 ? 62 : (62 + (line - 1) * 40));
                var padding = chatWidth > 420 ? (10 * 2) : 0;
                // åœ†è§’ä¸å˜å½¢
                await this.CoreDraw.drawImage('/assets/chat_box_1/1.png', left, top, 7, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_1/2.png', left + 7, top, chatWidth + padding, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_1/3.png', left + 7 + chatWidth + padding - 1, top, 7, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_1/4.png', left, top + 7, 7, height);
                await this.CoreDraw.drawImage('/assets/chat_box_1/5.png', left + 7, top + 7, chatWidth + padding, height);
                await this.CoreDraw.drawImage('/assets/chat_box_1/6.png', left + 7 + chatWidth + padding - 1, top + 7, 7, height);
                await this.CoreDraw.drawImage('/assets/chat_box_1/7.png', left, top + 7 + height, 7, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_1/8.png', left + 7, top + 7 + height, chatWidth + padding, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_1/9.png', left + 7 + chatWidth + padding - 1, top + 7 + height, 7, 7);
                await this.CoreDraw.drawImage('/text_bg_arrow.png', left - 11, top + 25, 12, 25);

                if (strs.length) {
                    strs.map((item, idx) => {
                        this.CoreDraw.drawText(item, 'Bold 30px "PingFang"', '#000', { x: left + 20, y: top + 20 + 40 * idx })
                    })
                } else {
                    this.CoreDraw.drawText(text, 'Bold 30px "PingFang"', '#000', { x: left + 20, y: top + 20 + 40 * line })
                }
                this.defaultTop += (height + 103 / 2)
            }

            async chatBox_other_2(avatar, text) {
                var left = 106
                var top = this.defaultTop
                this.drawAvatar(top, false)
                var chatWidth = this.strLengthWithDom(text)
                var width = 0;
                var line = 0;
                var lastIdx = 0;
                var strs = []
                for (var i = 0; i < text.length; i++) {
                    width += this.strLengthWithDom(text[i])
                    if (width > 420) {
                        var _text = text.substring(lastIdx, (i + (line === 0 ? 1 : 0)))
                        strs.push(_text)
                        lastIdx = i;
                        width = 0;
                        line++;
                    }

                    if (i === text.length - 1) {
                        strs.push(text.substring(lastIdx + 1))
                        line++;
                    }
                }

                if (chatWidth > 420) {
                    // æ¢è¡Œ
                    chatWidth = 440;
                }
                var padding = chatWidth > 420 ? (10 * 2) : 0;
                var left = this.CoreDraw.getWidth() - (chatWidth + padding) - 115 - 14;
                var top = top;
                var height = (line === 0 ? 62 : (62 + (line - 1) * 40));
                // åœ†è§’ä¸å˜å½¢
                await this.CoreDraw.drawImage('/assets/chat_box_2/1.png', left, top, 7, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_2/2.png', left + 7, top, chatWidth + padding, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_2/3.png', left + 7 + chatWidth + padding - 1, top, 7, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_2/4.png', left, top + 7, 7, height);
                await this.CoreDraw.drawImage('/assets/chat_box_2/5.png', left + 7, top + 7, chatWidth + padding, height);
                await this.CoreDraw.drawImage('/assets/chat_box_2/6.png', left + 7 + chatWidth + padding - 1, top + 7, 7, height);
                await this.CoreDraw.drawImage('/assets/chat_box_2/7.png', left, top + 7 + height, 7, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_2/8.png', left + 7, top + 7 + height, chatWidth + padding, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_2/9.png', left + 7 + chatWidth + padding - 1, top + 7 + height, 7, 7);
                await this.CoreDraw.drawImage('/assets/chat_box_2/arrow.png', 633, top + 25, 12, 25);
                if (strs.length) {
                    strs.map((item, idx) => {
                        this.CoreDraw.drawText(item, 'Bold 30px "PingFang"', '#000', { x: left + 20, y: top + 20 + 40 * idx })
                    })
                } else {
                    this.CoreDraw.drawText(text, 'Bold 30px "PingFang"', '#000', { x: left + 20, y: top + 20 + 40 * line })
                }
                this.defaultTop += (height + 103 / 2)
            }

            drawNickName(text) {
                this.CoreDraw.ctx.font = 'Bold 30px "PingFang"'
                var width = this.CoreDraw.ctx.measureText(text).width
                this.CoreDraw.drawText(text, 'Bold 38px "PingFang"', '#fff',
                    {
                        x: (this.CoreDraw.getWidth() - width) / 2 - 5,
                        y: 62
                    }
                )
                this.CoreDraw.drawText(text, 'Bold 38px "PingFang"', '#fff',
                    {
                        x: (this.CoreDraw.getWidth() - width) / 2 - 5 - 0.5,
                        y: 62 - 0.5
                    }
                )
            }

            getDistUrl() {
                return this.CoreDraw.outBase64()
            }

            getDistStream() {
                return this.CoreDraw.outImage()
            }
        }

        var main = async function () {
            var talk1 = async function () {
               await fake1.chatBox_other_1('', 'å¯ä»¥å¯ä»¥å¯ä»¥å¯ä»¥ğŸ¤¨ğŸ¤¨ğŸ¤¨')
            }
            var fake1 = new FakeIos()
            await fake1.drawTempBg()
            fake1.drawWifi(true)
            fake1.drawTime('ä¸Šåˆ1:56')


            // //  fake1.chatBox_other_1('', '@æ¡€ ğŸ˜€')
            // fake1.chatBox_o`ther_1('', 'å¯ä»¥å¯ä»¥å¯ä»¥å¯ä»¥')
            // fake1.chatBox_other_2('', 'beestoreå¾ˆå¥½ç”¨çš„ğŸ˜€ï¼Œä¸éœ€è¦æµ·å¤–ID')
            // fake1.chatBox_other_1('', 'åƒç“œç¾¤ä¼—è¡¨ç¤º åœ¨éå®˜æ–¹å¹³å°ä¸‹appå¾ˆä¸æ”¾å¿ƒ')
            // fake1.chatBox_other_2('', 'è€æ¿äº²è‡ªå‘å¹¿å‘Š?')
            // fake1.chatBox_other_1('', 'å“ˆå“ˆå“ˆå“ˆ')
            // fake1.chatBox_other_2('', 'å“ˆå“ˆå“ˆå“ˆ1')
            fake1.drawNickName('æ— æ•Œç¾å°‘å¥³ğŸ¤¨')
            await talk1()
            await talk1()
            await talk1()
            // talk1()
            // talk1()
        }
        main()
    </script>

</body>

</html>